# Controlit DB
## Disclaimer
Все таблицы с сущностями содержат поля `id`, `created`, `updated`, `deleted`.

Поле | Описание
------------ | -------------
id | Автоинкрементируемое поле `integer`. <br> При вставке не нужно указывать.
created | Timestame без таймзоны. Все значения хранятся в UTC. По умолчанию устанавливает текущее временное значение.
updated | Timestame без таймзоны. Все значения хранятся в UTC. Проставляет текущее временное значение при любом изменении полей в записи.
deleted | Timestame без таймзоны. Все значения хранятся в UTC. Необязательное поле, которое можно использовать для пометки, что запись удалена (при этом физически не удалять). Удобно, когда клиент в панике пишет, что все удалил, а надо восстановить. Неудобно, что надо учитывать, актуальная ли запись, при выборках.

## Tables
### person
Таблица содерижит информацию о пользователях.
Поле | Описание
------------ | -------------
email | строка
password | строка для хранения хеша пароля
admin | `boolean` является ли пользователь админом. По умолчанию `false`
usrrnd | строка идентификатор сессии

#####  Примеры запросов:
Получение всех админов. Получение списка компаний, к которым есть доступ у пользователя.
```sql
select * from user where admin is true;
```

### business_info
Таблица содержит информацию о руководителе компании и отвественном за объект и их контактные данные.
Поле | Описание
------------ | -------------
company_name | строка название компании
inn | ИНН компании (уникальный)
director | строка ФИО руководителя компании
director_telephone | строка телефон руководителя компании
director_email | строка электронная почта руководителя компании
respondent | строка ФИО ответсвенного за объект
respondent_telephone | строка телефон ответсвенного за объект
respondent_email | строка электронная почта ответсвенного за объект

#####  Примеры запросов:
Создание нового `business_info` и редактирование по id. 
```sql
insert into public.business_info ( 
    company_name, inn, director, director_telephone, director_email, respondent, respondent_telephone, respondent_email)
values
    ( 'company_4', '123452349012', 'Петр Сргеевич', '79123874455', 'director_4@yandex.ru', 'Федор Петрович', '79112228844', 'respondent_4@mail.ru');
```
```sql
update public.business_info set director_telephone = '79884567092' where id = 4;
```
### country
Таблица содержит информацию о странах
Поле | Описание
------------ | -------------
name | строка наименование страны
#####  Примеры запросов:
Список всех регионов:
```sql
select region.name from public.region
inner join public.district on region.district_id = district.id
where district.country_id = 1;
```

### district
Таблица содержит информацию об округах
Поле | Описание
------------ | -------------
name | строка наименование округа
country_id | id из таблицы [country](#country)
#####  Примеры запросов:
Список всех регионов:
```sql
select region.name from public.region
where region.district_id = 3;
```
Получение дистрибьютера:
```sql
select cluster.distributor_id from"public.cluster
inner join public.cluster_link_district on cluster_id = cluster.id
where cluster_link_district.district_id = 8;
```
### region
Таблица содержит информацию о регионах
Поле | Описание
------------ | -------------
name | строка наименование региона
district_id | id из таблицы [district](#district)
#####  Примеры запросов:
Получение дистрибьютера:
```sql
```
Получение всех городов в регионе:
```sql
select city.name from public.city 
inner join public.region on region.id = city.region_id
where region_id = 6;
```

### city
Таблица содержит информацию о городах
Поле | Описание
------------ | -------------
name | строка наименование города
region_id | id из таблицы [region](#region)
#####  Примеры запросов:
Получение дистрибьютера:
```sql
```
Получение региона:
```sql
select region.name from public.region 
inner join public.city on region.id = city.region_id
where city.id = 7;
```

### company
Таблица содержит информацию о компании
Поле | Описание
------------ | -------------
name | строка
organization_type | строка для указания организационной формы: ООО, ЗАО, ИП и тп
inn | `bigint` уникальный
ogrn | `bigint` уникальный
bik_bank | `integer` БИК банка
bank_name | строка название банка
bank_account | `numeric(20,0)` расчетный счет юридического лица, состоит из 20 цифр
company_email | строка
telephone | строка телефоны компании
post_address | строка для почтового адрес компании
company_type | строка для выбора типа пользователя системой: дилер или дистрибьютор
availability | строка для указания признака доступности: включен, выключен и ограничен. По умолчанию включен. Если выключен – пользователь блокируется
change_dealer | `boolean` возможность менять дилеров. По умолчанию "нет", включается администратором
city_id | id из таблицы [city](#city)
#####  Примеры запросов:
Получение всех объектов (если дилер):
```sql
```
Получение кластера:
```sql
```

### company_link_region
Третья таблица для связки m2m таблиц company и region

Привязывание компании к региону:
```sql
```
Получение компаний в регионе:
```sql
```

### person_link_company
Третья таблица для связки m2m таблиц person и company 

Привязывание пользователя к компании:
```sql
```
Список пользователей у компании:
```sql
```

### cluster
Таблица содержит информацию о кластерах
Поле | Описание
------------ | -------------
name | строка
base_cost | `double precision` 
distributor_id | id из таблицы [company](#company)

Установка дистрибьютера:
```sql
```

### cluster_link_city
Привязывание города к кластеру:
```sql
```

### cluster_link_country
Привязывание страны к кластеру:
```sql
```
### cluster_link_district
Привязывание округа к кластеру:
```sql
```

### cluster_link_region
Привязывание области к кластеру:
```sql
```
### file
Создание файла:
```sql
```

### media
Создание медиа об объекте:
```sql
```

### contract
Создание договора с юрлицом (сначала файл, потом запись в контракт):
```sql
```

### commercial_proposal
Создание нового Коммерческого предложения. Получение последнего созданного:
```sql
```

### building
Получение общей информации по объекты (по всем полям вложенные join):
```sql
```
Получение всех медиа об объекте:
```sql
```
Получение дистрибьютера, если есть city:
```sql
```
Получение всех фото:
```sql
```
Получение всех медиа об объекте:
```sql
```

### building_link_media
НАДО УБРАТЬ
### building_photos_link_file
Добавление фотографии к объекту (сначала файл, потом инстерт в третью таблицу):
```sql
```

### building_roof_approval_link_file
Добавление файлов подтверждения крыши объекта (сначала файл, потом инстерт в третью таблицу):
```sql
```
### building_roof_link_file
Добавление файлов крыши объекта (сначала файл, потом инстерт в третью таблицу):
```sql
```
Получение всех завершенных объектов данного дилера отсортированных по сумме затрат на материалы:
```sql
```
Получение всех объектов без дилера в регионе:
```sql
```
Получение всех объектов в кластере:
```sql
```

Получение последних 10 просмотренных объектов:
```sql
```

### visit_building
Запись о просмотре объекта:
```sql
```
### diagnostic
Создание диагностики:
```sql
```
### diagnostic_link_file
Получение полной информации о диагностике:
```sql
```
### presentation
Созадание презентации:
```sql
```
Получение всех презентаций объекта отсортированнх по дате создания (обратный порядок):
```sql
```
### supply
Подача заявки на поставку дилером:
```sql
```
Получение всех открытых заявок в кластере:
```sql
```
### request
Получение открытых запросов на объекты дилерами в кластере:
```sql
```
Создание заявки на объект дилером:
```sql
```
